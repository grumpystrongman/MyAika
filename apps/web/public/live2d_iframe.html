<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aika Live2D</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: transparent;
      }
      canvas {
        width: 100%;
        height: 100%;
        display: block;
      }
    </style>
  </head>
  <body>
    <canvas id="live2d"></canvas>
    <script src="/vendor/pixi.min.js"></script>
    <script src="/assets/aika/live2d/live2dcubismcore.js"></script>
    <script src="/vendor/cubism4.min.js"></script>
    <script>
      (function () {
        const canvas = document.getElementById("live2d");
        const params = new URLSearchParams(window.location.search);
        const modelUrl = params.get("model") || "";

        if (!window.PIXI || !window.PIXI.live2d || !window.PIXI.live2d.Live2DModel) {
          window.parent?.postMessage({ type: "live2d_error", message: "live2d_runtime_missing" }, "*");
          return;
        }

        const { Live2DModel } = window.PIXI.live2d;
        const app = new window.PIXI.Application({
          view: canvas,
          autoStart: true,
          backgroundAlpha: 0
        });

        let model = null;
        let state = { isTalking: false, talkIntensity: 0.5, isListening: false, mood: "neutral" };

        function layout() {
          if (!model) return;
          const width = app.renderer.width || canvas.clientWidth || 1;
          const height = app.renderer.height || canvas.clientHeight || 1;
          const bounds = model.getBounds ? model.getBounds() : { width: model.width || 1, height: model.height || 1 };
          const scale = Math.min(width / bounds.width, height / bounds.height) * 0.95;
          model.scale.set(scale);
          if (model.anchor && model.anchor.set) {
            model.anchor.set(0.5, 1);
          }
          model.x = width * 0.5;
          model.y = height * 0.98;
        }

        function setMood(mood) {
          if (!model) return;
          if (model.expression) {
            model.expression(mood).catch(() => {});
          }
        }

        async function loadModel(url) {
          if (!url) return;
          try {
            model = await Live2DModel.from(url);
            app.stage.addChild(model);
            layout();
            setMood(state.mood);
          } catch (err) {
            window.parent?.postMessage({ type: "live2d_error", message: err?.message || "live2d_load_failed" }, "*");
          }
        }

        app.ticker.add((delta) => {
          if (!model) return;
          const core = model.internalModel?.coreModel;
          if (core?.setParameterValueById) {
            const mouth = state.isTalking ? state.talkIntensity : 0;
            core.setParameterValueById("ParamMouthOpenY", mouth);
          }
          if (model.update) model.update(delta);
        });

        window.addEventListener("message", (ev) => {
          if (!ev?.data || ev.data.type !== "state") return;
          state = { ...state, ...ev.data };
          if (ev.data.mood) setMood(ev.data.mood);
        });

        window.addEventListener("resize", () => {
          const w = canvas.clientWidth || canvas.width || 1;
          const h = canvas.clientHeight || canvas.height || 1;
          app.renderer.resize(w, h);
          layout();
        });

        loadModel(modelUrl);
      })();
    </script>
  </body>
</html>
